<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Part-1 (Customer) ‚Äî Booking</title>
<style>
  body{margin:0;font-family:Arial;background:#ffffff;color:#111}
  .wrap{max-width:900px;margin:auto;padding:18px}
  h2{color:#111;margin:0 0 10px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  label{font-size:12px;opacity:.85;display:block;margin:10px 0 6px}
  input,select,textarea,button{
    width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;
    background:#fff;color:#111;outline:none
  }
  input:focus,select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:650px){.row{grid-template-columns:1fr}}
  .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  @media(max-width:650px){.slots{grid-template-columns:repeat(2,1fr)}}
  .slot{
    padding:10px;border-radius:12px;border:1px solid #d1d5db;background:#f3f4f6;
    cursor:pointer;text-align:center;user-select:none
  }
  .slot.selected{background:#2563eb;border-color:#2563eb;color:#fff}
  .slot.disabled{opacity:.45;text-decoration:line-through;cursor:not-allowed}
  button{background:#2563eb;color:#fff;font-weight:bold;cursor:pointer;margin-top:12px;border:none}
  button:disabled{opacity:.6;cursor:not-allowed}
  .btn2{background:#f3f4f6;color:#111;border:1px solid #d1d5db;margin-top:8px}
  .hint{font-size:12px;color:#374151;margin-top:6px;line-height:1.4}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .box{width:min(560px,100%);background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
  .box h3{margin:0 0 8px;color:#111}
  .box pre{white-space:pre-wrap;background:#f3f4f6;border:1px solid #e5e7eb;padding:10px;border-radius:12px;margin:10px 0;color:#111}
</style>
</head>
<body>

<div class="wrap">
  <h2>Customer Query</h2>

  <div class="card">
    <div class="row">
      <div>
        <label>Service *</label>
        <select id="service">
          <option value="AC Repair">AC Repair</option>
        </select>
      </div>
      <div>
        <label>Date *</label>
        <input id="date" type="date">
      </div>
    </div>

    <div class="row">
      <div><label>Name *</label><input id="name" placeholder="Customer name"></div>
      <div>
        <label>Mobile (10 digit) *</label>
        <input id="phone" type="tel" maxlength="10" placeholder="10 digit mobile">
        <div class="hint">Sirf 10 digit number. (+91 / spaces nahi)</div>
      </div>
    </div>

    <label>Email (.com) *</label>
    <input id="email" placeholder="example@gmail.com">
    <div class="hint">Email me @ aur .com hona chahiye.</div>

    <div class="row">
      <div>
        <label>Pincode (6 digit) *</label>
        <input id="pincode" inputmode="numeric" maxlength="6" placeholder="e.g. 302015">
        <div class="hint" id="pinHint">Pincode validate ho raha hai‚Ä¶</div>
      </div>
      <div>
        <label>Address *</label>
        <input id="address" placeholder="House no, Area, Landmark, Jaipur">
      </div>
    </div>

    <label>Location Link (Google Maps) *</label>
    <input id="locationLink" placeholder="Auto fill by button OR paste Google Maps link">
    <button type="button" class="btn2" id="btnLoc">üìç Use my current location</button>
    <button type="button" class="btn2" id="btnMap">üó∫Ô∏è Open Map at my location</button>

    <label>Problem / Query *</label>
    <textarea id="problem" placeholder="Cooling/noise/leak etc."></textarea>

    <h3 style="margin:14px 0 6px;color:#111">Select Slot *</h3>
    <div class="slots" id="slots"></div>

    <button id="btn" disabled>‚úÖ Confirm Booking</button>
  </div>
</div>

<div class="modal" id="modal" onclick="if(event.target.id==='modal')closeModal()">
  <div class="box">
    <h3 id="mt">Message</h3>
    <pre id="mb"></pre>
    <button onclick="closeModal()">OK</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby6J1PUZdgXAh-T7GVN5SJtw3lM_JeFUyDtj6Zk71ppOik-4wTkqW6zFyswwagNRs76UQ/exec";

const START_HOUR = 10, END_HOUR = 19, LUNCH_START = 14, LUNCH_END = 15;
let selectedSlot = "";
let lastLat = null, lastLng = null;

let ALLOWED_PINS = [];      // fetched from .gs
let PIN_OK = false;

const $ = (id)=>document.getElementById(id);
function openModal(title, body){ $("mt").textContent = title; $("mb").textContent = body; $("modal").style.display="flex"; }
function closeModal(){ $("modal").style.display="none"; }

// validations
function validPhone(p){ return /^[0-9]{10}$/.test(p); }
function validEmail(email){ return /^[^\s@]+@[^\s@]+\.com$/i.test(email); }
function validPincode(pin){ return /^[0-9]{6}$/.test(pin); }

// slot helpers
function pad2(n){ return String(n).padStart(2,"0"); }
function fmt(h){ const ampm=h>=12?"PM":"AM"; const hh=((h+11)%12)+1; return `${hh}:00 ${ampm}`; }
function slotLabel(h){ return `${fmt(h)} - ${fmt(h+1)}`; }
function todayYMD(){ const now=new Date(); return `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`; }
function isTodaySelected(){ return $("date").value === todayYMD(); }

function renderSlots(){
  const box=$("slots");
  box.innerHTML=""; selectedSlot="";
  const now=new Date();
  const currentMinutes = now.getHours()*60 + now.getMinutes();
  const today = isTodaySelected();

  for(let h=START_HOUR; h<END_HOUR; h++){
    if(h>=LUNCH_START && h<LUNCH_END) continue;

    const slotEndMinutes = (h+1)*60;
    const isPast = today && (currentMinutes >= slotEndMinutes);

    const div=document.createElement("div");
    div.className="slot";
    div.textContent=slotLabel(h);

    if(isPast){
      div.classList.add("disabled");
    } else {
      div.onclick=()=>{
        document.querySelectorAll("#slots .slot").forEach(x=>x.classList.remove("selected"));
        div.classList.add("selected");
        selectedSlot = div.textContent;
        updateBtn();
      };
    }
    box.appendChild(div);
  }
  updateBtn();
}

function updatePinStatus(showPopupIfInvalid=false){
  const pin = $("pincode").value.trim();
  PIN_OK = false;

  if(!validPincode(pin)){
    $("pinHint").textContent = "6 digit pincode dalen.";
    $("pinHint").style.color = "#374151";
    updateBtn();
    return;
  }

  if(ALLOWED_PINS.length && !ALLOWED_PINS.includes(pin)){
    $("pinHint").textContent = "Our services not available at this pincode.";
    $("pinHint").style.color = "#b91c1c";
    if(showPopupIfInvalid){
      openModal("‚ùå Service Not Available", "Our services not available at this pincode.");
    }
    updateBtn();
    return;
  }

  PIN_OK = true;
  $("pinHint").textContent = "‚úÖ Service available for this pincode.";
  $("pinHint").style.color = "#047857";
  updateBtn();
}

function updateBtn(){
  const ok =
    $("date").value &&
    $("name").value.trim() &&
    validPhone($("phone").value.trim()) &&
    validEmail($("email").value.trim()) &&
    validPincode($("pincode").value.trim()) &&
    PIN_OK &&
    $("address").value.trim() &&
    $("locationLink").value.trim() &&
    $("problem").value.trim() &&
    selectedSlot;

  $("btn").disabled = !ok;
}

function resetForm(){
  $("service").value="AC Repair";
  $("name").value=""; $("phone").value="";
  $("email").value="";
  $("pincode").value="";
  $("address").value="";
  $("locationLink").value="";
  $("problem").value="";
  selectedSlot="";
  lastLat=null; lastLng=null;
  PIN_OK=false;
  document.querySelectorAll("#slots .slot").forEach(x=>x.classList.remove("selected"));
  $("pinHint").textContent = (ALLOWED_PINS.length ? "6 digit pincode dalen." : "Pincode validate ho raha hai‚Ä¶");
  $("pinHint").style.color = "#374151";
  updateBtn();
}

// input sanitization
$("phone").addEventListener("input", ()=>{ $("phone").value = $("phone").value.replace(/\D/g,"").slice(0,10); updateBtn(); });
$("pincode").addEventListener("input", ()=>{
  $("pincode").value = $("pincode").value.replace(/\D/g,"").slice(0,6);
  updatePinStatus(false);
});

// When pincode field loses focus -> show popup if invalid
$("pincode").addEventListener("blur", ()=> updatePinStatus(true));

async function getCurrentCoords(){
  return new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error("Geolocation not supported"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lng:pos.coords.longitude}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:10000 }
    );
  });
}

// Use my current location -> auto fill link + save lat/lng
$("btnLoc").addEventListener("click", async ()=>{
  try{
    $("btnLoc").disabled = true;
    $("btnLoc").textContent = "üìç Getting location...";
    const {lat, lng} = await getCurrentCoords();
    lastLat = lat; lastLng = lng;
    $("locationLink").value = `https://www.google.com/maps?q=${lat},${lng}`;
    openModal("‚úÖ Location Added", "Location link auto fill ho gaya.");
  }catch(e){
    openModal("‚ùå Location Error", "Location allow nahi hua.\nPlease GPS allow karo ya link paste karo.\n\n" + (e?.message || e));
  }finally{
    $("btnLoc").disabled = false;
    $("btnLoc").textContent = "üìç Use my current location";
    updateBtn();
  }
});

// Map picker -> DIRECT current location par open
$("btnMap").addEventListener("click", async ()=>{
  try{
    $("btnMap").disabled = true;
    $("btnMap").textContent = "üó∫Ô∏è Opening map...";
    if(lastLat===null || lastLng===null){
      const {lat, lng} = await getCurrentCoords();
      lastLat = lat; lastLng = lng;
      if(!$("locationLink").value.trim()){
        $("locationLink").value = `https://www.google.com/maps?q=${lat},${lng}`;
      }
    }
    window.open(`https://www.google.com/maps/@${lastLat},${lastLng},18z`, "_blank");
  }catch(e){
    openModal("‚ùå Map Error", "Map open nahi hua.\nGPS allow karo ya link paste karo.\n\n" + (e?.message || e));
  }finally{
    $("btnMap").disabled = false;
    $("btnMap").textContent = "üó∫Ô∏è Open Map at my location";
    updateBtn();
  }
});

// fetch allowed pincodes from .gs
async function loadAllowedPincodes(){
  try{
    const res = await fetch(API_URL + "?action=pincodes", { method:"GET" });
    const txt = await res.text();
    const out = JSON.parse(txt);
    if(out && out.ok && Array.isArray(out.pincodes)){
      ALLOWED_PINS = out.pincodes.map(String);
      $("pinHint").textContent = "6 digit pincode dalen.";
      $("pinHint").style.color = "#374151";
      updatePinStatus(false);
    }else{
      $("pinHint").textContent = "Pincode list load nahi hui. Admin se contact karein.";
      $("pinHint").style.color = "#b91c1c";
    }
  }catch(e){
    $("pinHint").textContent = "Pincode list load nahi hui. Internet / API_URL check karein.";
    $("pinHint").style.color = "#b91c1c";
  }
}

$("btn").onclick = async ()=>{
  try{
    // final pin check before submit
    updatePinStatus(true);
    if(!PIN_OK){
      updateBtn();
      return;
    }

    $("btn").disabled = true;

    const payload = {
      action:"create",
      service:$("service").value,
      date:$("date").value,
      slot:selectedSlot,
      name:$("name").value.trim(),
      phone:$("phone").value.trim(),
      email:$("email").value.trim(),
      pincode:$("pincode").value.trim(),
      address:$("address").value.trim(),
      locationLink:$("locationLink").value.trim(),
      lat:lastLat===null ? "" : String(lastLat),
      lng:lastLng===null ? "" : String(lastLng),
      problem:$("problem").value.trim()
    };

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify(payload)
    });

    const txt = await res.text();
    let out;
    try{ out = JSON.parse(txt); } catch(e){ throw new Error("Non-JSON response:\n"+txt.slice(0,250)); }

    if(out && out.ok){
      openModal("‚úÖ Booking Saved", "Booking ID: " + out.bookingId + (out.teamName ? ("\nTeam: " + out.teamName) : ""));
      resetForm();
      renderSlots();
    }else{
      openModal("‚ùå Error", out?.error || "Failed");
      updateBtn();
    }
  }catch(e){
    openModal("‚ùå Error", String(e));
    updateBtn();
  }
};

(function init(){
  const t = todayYMD();
  $("date").min = t;
  $("date").value = t;
  renderSlots();

  ["service","name","email","address","locationLink","problem"].forEach(id=>{
    $(id).addEventListener("input", updateBtn);
    $(id).addEventListener("change", updateBtn);
  });
  $("date").addEventListener("change", ()=>renderSlots());
  setInterval(()=>{ if(isTodaySelected()) renderSlots(); }, 60000);

  loadAllowedPincodes();
})();
</script>
</body>
</html>
